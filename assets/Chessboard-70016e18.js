var Ft=Object.defineProperty;var $t=(e,t,o)=>t in e?Ft(e,t,{enumerable:!0,configurable:!0,writable:!0,value:o}):e[t]=o;var P=(e,t,o)=>($t(e,typeof t!="symbol"?t+"":t,o),o);import{C as nt,r as Qt,D as We,f as st,B as Me,o as ce,c as qe,e as le,s as at,A as Wt,n as lt,p as jt,F as Ut,T as Gt,E as Ht,h as zt,m as Zt,l as Yt}from"./index-d33e413e.js";const Xt={class:"promotion-dialog",open:""},Jt=["aria-label","onClick","onTouchstartPassive"],eo=nt({__name:"PromotionDialog",props:{state:{}},emits:["promotionSelected"],setup(e,{emit:t}){const o=e,r=[{name:"Queen",data:"q"},{name:"Knight",data:"n"},{name:"Rook",data:"r"},{name:"Bishop",data:"b"}];function i(n){var a,s;(s=(a=o.state).callback)==null||s.call(a,n.data),t("promotionSelected")}return(n,a)=>(ce(),at(Gt,{to:"cg-board"},[le("dialog",Xt,[(ce(),qe(Ut,null,jt(r,s=>le("button",{key:s.name,class:lt([s.name.toLowerCase(),n.state.color]),"aria-label":s.name,onClick:l=>i(s),onTouchstartPassive:l=>i(s)},null,42,Jt)),64))])]))}});/**
 * @license
 * Copyright (c) 2023, Jeff Hlywa (jhlywa@gmail.com)
 * All rights reserved.
 *
 * Redistribution and use in source and binary forms, with or without
 * modification, are permitted provided that the following conditions are met:
 *
 * 1. Redistributions of source code must retain the above copyright notice,
 *    this list of conditions and the following disclaimer.
 * 2. Redistributions in binary form must reproduce the above copyright notice,
 *    this list of conditions and the following disclaimer in the documentation
 *    and/or other materials provided with the distribution.
 *
 * THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS AND CONTRIBUTORS "AS IS"
 * AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE
 * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE
 * ARE DISCLAIMED. IN NO EVENT SHALL THE COPYRIGHT OWNER OR CONTRIBUTORS BE
 * LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
 * CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
 * SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
 * INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
 * CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
 * ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
 * POSSIBILITY OF SUCH DAMAGE.
 */const M="w",x="b",C="p",Te="n",me="b",ae="r",G="q",E="k",we="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",N=-1,to={NORMAL:"n",CAPTURE:"c",BIG_PAWN:"b",EP_CAPTURE:"e",PROMOTION:"p",KSIDE_CASTLE:"k",QSIDE_CASTLE:"q"},oo=["a8","b8","c8","d8","e8","f8","g8","h8","a7","b7","c7","d7","e7","f7","g7","h7","a6","b6","c6","d6","e6","f6","g6","h6","a5","b5","c5","d5","e5","f5","g5","h5","a4","b4","c4","d4","e4","f4","g4","h4","a3","b3","c3","d3","e3","f3","g3","h3","a2","b2","c2","d2","e2","f2","g2","h2","a1","b1","c1","d1","e1","f1","g1","h1"],m={NORMAL:1,CAPTURE:2,BIG_PAWN:4,EP_CAPTURE:8,PROMOTION:16,KSIDE_CASTLE:32,QSIDE_CASTLE:64},b={a8:0,b8:1,c8:2,d8:3,e8:4,f8:5,g8:6,h8:7,a7:16,b7:17,c7:18,d7:19,e7:20,f7:21,g7:22,h7:23,a6:32,b6:33,c6:34,d6:35,e6:36,f6:37,g6:38,h6:39,a5:48,b5:49,c5:50,d5:51,e5:52,f5:53,g5:54,h5:55,a4:64,b4:65,c4:66,d4:67,e4:68,f4:69,g4:70,h4:71,a3:80,b3:81,c3:82,d3:83,e3:84,f3:85,g3:86,h3:87,a2:96,b2:97,c2:98,d2:99,e2:100,f2:101,g2:102,h2:103,a1:112,b1:113,c1:114,d1:115,e1:116,f1:117,g1:118,h1:119},ye={b:[16,32,17,15],w:[-16,-32,-17,-15]},je={n:[-18,-33,-31,-14,18,33,31,14],b:[-17,-15,17,15],r:[-16,1,16,-1],q:[-17,-16,-15,1,17,16,15,-1],k:[-17,-16,-15,1,17,16,15,-1]},ro=[20,0,0,0,0,0,0,24,0,0,0,0,0,0,20,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,24,24,24,24,24,24,56,0,56,24,24,24,24,24,24,0,0,0,0,0,0,2,53,56,53,2,0,0,0,0,0,0,0,0,0,0,0,20,2,24,2,20,0,0,0,0,0,0,0,0,0,0,20,0,0,24,0,0,20,0,0,0,0,0,0,0,0,20,0,0,0,24,0,0,0,20,0,0,0,0,0,0,20,0,0,0,0,24,0,0,0,0,20,0,0,0,0,20,0,0,0,0,0,24,0,0,0,0,0,20,0,0,20,0,0,0,0,0,0,24,0,0,0,0,0,0,20],io=[17,0,0,0,0,0,0,16,0,0,0,0,0,0,15,0,0,17,0,0,0,0,0,16,0,0,0,0,0,15,0,0,0,0,17,0,0,0,0,16,0,0,0,0,15,0,0,0,0,0,0,17,0,0,0,16,0,0,0,15,0,0,0,0,0,0,0,0,17,0,0,16,0,0,15,0,0,0,0,0,0,0,0,0,0,17,0,16,0,15,0,0,0,0,0,0,0,0,0,0,0,0,17,16,15,0,0,0,0,0,0,0,1,1,1,1,1,1,1,0,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,-15,-16,-17,0,0,0,0,0,0,0,0,0,0,0,0,-15,0,-16,0,-17,0,0,0,0,0,0,0,0,0,0,-15,0,0,-16,0,0,-17,0,0,0,0,0,0,0,0,-15,0,0,0,-16,0,0,0,-17,0,0,0,0,0,0,-15,0,0,0,0,-16,0,0,0,0,-17,0,0,0,0,-15,0,0,0,0,0,-16,0,0,0,0,0,-17,0,0,-15,0,0,0,0,0,0,-16,0,0,0,0,0,0,-17],no={p:1,n:2,b:4,r:8,q:16,k:32},so="pnbrqkPNBRQK",Ue=[Te,me,ae,G],ao=7,lo=6,co=1,ho=0,ge={[E]:m.KSIDE_CASTLE,[G]:m.QSIDE_CASTLE},Q={w:[{square:b.a1,flag:m.QSIDE_CASTLE},{square:b.h1,flag:m.KSIDE_CASTLE}],b:[{square:b.a8,flag:m.QSIDE_CASTLE},{square:b.h8,flag:m.KSIDE_CASTLE}]},uo={b:co,w:lo},po=["1-0","0-1","1/2-1/2","*"];function X(e){return e>>4}function he(e){return e&15}function ct(e){return"0123456789".indexOf(e)!==-1}function q(e){const t=he(e),o=X(e);return"abcdefgh".substring(t,t+1)+"87654321".substring(o,o+1)}function ie(e){return e===M?x:M}function fo(e){const t=e.split(/\s+/);if(t.length!==6)return{ok:!1,error:"Invalid FEN: must contain six space-delimited fields"};const o=parseInt(t[5],10);if(isNaN(o)||o<=0)return{ok:!1,error:"Invalid FEN: move number must be a positive integer"};const r=parseInt(t[4],10);if(isNaN(r)||r<0)return{ok:!1,error:"Invalid FEN: half move counter number must be a non-negative integer"};if(!/^(-|[abcdefgh][36])$/.test(t[3]))return{ok:!1,error:"Invalid FEN: en-passant square is invalid"};if(/[^kKqQ-]/.test(t[2]))return{ok:!1,error:"Invalid FEN: castling availability is invalid"};if(!/^(w|b)$/.test(t[1]))return{ok:!1,error:"Invalid FEN: side-to-move is invalid"};const i=t[0].split("/");if(i.length!==8)return{ok:!1,error:"Invalid FEN: piece data does not contain 8 '/'-delimited rows"};for(let a=0;a<i.length;a++){let s=0,l=!1;for(let c=0;c<i[a].length;c++)if(ct(i[a][c])){if(l)return{ok:!1,error:"Invalid FEN: piece data is invalid (consecutive number)"};s+=parseInt(i[a][c],10),l=!0}else{if(!/^[prnbqkPRNBQK]$/.test(i[a][c]))return{ok:!1,error:"Invalid FEN: piece data is invalid (invalid piece)"};s+=1,l=!1}if(s!==8)return{ok:!1,error:"Invalid FEN: piece data is invalid (too many squares in rank)"}}if(t[3][1]=="3"&&t[1]=="w"||t[3][1]=="6"&&t[1]=="b")return{ok:!1,error:"Invalid FEN: illegal en-passant square"};const n=[{color:"white",regex:/K/g},{color:"black",regex:/k/g}];for(const{color:a,regex:s}of n){if(!s.test(t[0]))return{ok:!1,error:`Invalid FEN: missing ${a} king`};if((t[0].match(s)||[]).length>1)return{ok:!1,error:`Invalid FEN: too many ${a} kings`}}return{ok:!0}}function go(e,t){const o=e.from,r=e.to,i=e.piece;let n=0,a=0,s=0;for(let l=0,c=t.length;l<c;l++){const p=t[l].from,u=t[l].to,d=t[l].piece;i===d&&o!==p&&r===u&&(n++,X(o)===X(p)&&a++,he(o)===he(p)&&s++)}return n>0?a>0&&s>0?q(o):s>0?q(o).charAt(1):q(o).charAt(0):""}function W(e,t,o,r,i,n=void 0,a=m.NORMAL){const s=X(r);if(i===C&&(s===ao||s===ho))for(let l=0;l<Ue.length;l++){const c=Ue[l];e.push({color:t,from:o,to:r,piece:i,captured:n,promotion:c,flags:a|m.PROMOTION})}else e.push({color:t,from:o,to:r,piece:i,captured:n,flags:a})}function Ge(e){let t=e.charAt(0);return t>="a"&&t<="h"?e.match(/[a-h]\d.*[a-h]\d/)?void 0:C:(t=t.toLowerCase(),t==="o"?E:t)}function ke(e){return e.replace(/=/,"").replace(/[+#]?[?!]*$/,"")}class mo{constructor(t=we){P(this,"_board",new Array(128));P(this,"_turn",M);P(this,"_header",{});P(this,"_kings",{w:N,b:N});P(this,"_epSquare",-1);P(this,"_halfMoves",0);P(this,"_moveNumber",0);P(this,"_history",[]);P(this,"_comments",{});P(this,"_castling",{w:0,b:0});this.load(t)}clear(t=!1){this._board=new Array(128),this._kings={w:N,b:N},this._turn=M,this._castling={w:0,b:0},this._epSquare=N,this._halfMoves=0,this._moveNumber=1,this._history=[],this._comments={},this._header=t?this._header:{},this._updateSetup(this.fen())}removeHeader(t){t in this._header&&delete this._header[t]}load(t,o=!1){let r=t.split(/\s+/);if(r.length>=2&&r.length<6){const l=["-","-","0","1"];t=r.concat(l.slice(-(6-r.length))).join(" ")}r=t.split(/\s+/);const{ok:i,error:n}=fo(t);if(!i)throw new Error(n);const a=r[0];let s=0;this.clear(o);for(let l=0;l<a.length;l++){const c=a.charAt(l);if(c==="/")s+=8;else if(ct(c))s+=parseInt(c,10);else{const p=c<"a"?M:x;this.put({type:c.toLowerCase(),color:p},q(s)),s++}}this._turn=r[1],r[2].indexOf("K")>-1&&(this._castling.w|=m.KSIDE_CASTLE),r[2].indexOf("Q")>-1&&(this._castling.w|=m.QSIDE_CASTLE),r[2].indexOf("k")>-1&&(this._castling.b|=m.KSIDE_CASTLE),r[2].indexOf("q")>-1&&(this._castling.b|=m.QSIDE_CASTLE),this._epSquare=r[3]==="-"?N:b[r[3]],this._halfMoves=parseInt(r[4],10),this._moveNumber=parseInt(r[5],10),this._updateSetup(this.fen())}fen(){var n,a;let t=0,o="";for(let s=b.a8;s<=b.h1;s++){if(this._board[s]){t>0&&(o+=t,t=0);const{color:l,type:c}=this._board[s];o+=l===M?c.toUpperCase():c.toLowerCase()}else t++;s+1&136&&(t>0&&(o+=t),s!==b.h1&&(o+="/"),t=0,s+=8)}let r="";this._castling[M]&m.KSIDE_CASTLE&&(r+="K"),this._castling[M]&m.QSIDE_CASTLE&&(r+="Q"),this._castling[x]&m.KSIDE_CASTLE&&(r+="k"),this._castling[x]&m.QSIDE_CASTLE&&(r+="q"),r=r||"-";let i="-";if(this._epSquare!==N){const s=this._epSquare+(this._turn===M?16:-16),l=[s+1,s-1];for(const c of l){if(c&136)continue;const p=this._turn;if(((n=this._board[c])==null?void 0:n.color)===p&&((a=this._board[c])==null?void 0:a.type)===C){this._makeMove({color:p,from:c,to:this._epSquare,piece:C,captured:C,flags:m.EP_CAPTURE});const u=!this._isKingAttacked(p);if(this._undoMove(),u){i=q(this._epSquare);break}}}}return[o,this._turn,r,i,this._halfMoves,this._moveNumber].join(" ")}_updateSetup(t){this._history.length>0||(t!==we?(this._header.SetUp="1",this._header.FEN=t):(delete this._header.SetUp,delete this._header.FEN))}reset(){this.load(we)}get(t){return this._board[b[t]]||!1}put({type:t,color:o},r){if(so.indexOf(t.toLowerCase())===-1||!(r in b))return!1;const i=b[r];return t==E&&!(this._kings[o]==N||this._kings[o]==i)?!1:(this._board[i]={type:t,color:o},t===E&&(this._kings[o]=i),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),!0)}remove(t){const o=this.get(t);return delete this._board[b[t]],o&&o.type===E&&(this._kings[o.color]=N),this._updateCastlingRights(),this._updateEnPassantSquare(),this._updateSetup(this.fen()),o}_updateCastlingRights(){var r,i,n,a,s,l,c,p,u,d,_,h;const t=((r=this._board[b.e1])==null?void 0:r.type)===E&&((i=this._board[b.e1])==null?void 0:i.color)===M,o=((n=this._board[b.e8])==null?void 0:n.type)===E&&((a=this._board[b.e8])==null?void 0:a.color)===x;(!t||((s=this._board[b.a1])==null?void 0:s.type)!==ae||((l=this._board[b.a1])==null?void 0:l.color)!==M)&&(this._castling.w&=~m.QSIDE_CASTLE),(!t||((c=this._board[b.h1])==null?void 0:c.type)!==ae||((p=this._board[b.h1])==null?void 0:p.color)!==M)&&(this._castling.w&=~m.KSIDE_CASTLE),(!o||((u=this._board[b.a8])==null?void 0:u.type)!==ae||((d=this._board[b.a8])==null?void 0:d.color)!==x)&&(this._castling.b&=~m.QSIDE_CASTLE),(!o||((_=this._board[b.h8])==null?void 0:_.type)!==ae||((h=this._board[b.h8])==null?void 0:h.color)!==x)&&(this._castling.b&=~m.KSIDE_CASTLE)}_updateEnPassantSquare(){var n,a;if(this._epSquare===N)return;const t=this._epSquare+(this._turn===M?-16:16),o=this._epSquare+(this._turn===M?16:-16),r=[o+1,o-1];if(this._board[t]!==null||this._board[this._epSquare]!==null||((n=this._board[o])==null?void 0:n.color)!==ie(this._turn)||((a=this._board[o])==null?void 0:a.type)!==C){this._epSquare=N;return}const i=s=>{var l,c;return!(s&136)&&((l=this._board[s])==null?void 0:l.color)===this._turn&&((c=this._board[s])==null?void 0:c.type)===C};r.some(i)||(this._epSquare=N)}_attacked(t,o){for(let r=b.a8;r<=b.h1;r++){if(r&136){r+=7;continue}if(this._board[r]===void 0||this._board[r].color!==t)continue;const i=this._board[r],n=r-o;if(n===0)continue;const a=n+119;if(ro[a]&no[i.type]){if(i.type===C){if(n>0){if(i.color===M)return!0}else if(i.color===x)return!0;continue}if(i.type==="n"||i.type==="k")return!0;const s=io[a];let l=r+s,c=!1;for(;l!==o;){if(this._board[l]!=null){c=!0;break}l+=s}if(!c)return!0}}return!1}_isKingAttacked(t){const o=this._kings[t];return o===-1?!1:this._attacked(ie(t),o)}isAttacked(t,o){return this._attacked(o,b[t])}isCheck(){return this._isKingAttacked(this._turn)}inCheck(){return this.isCheck()}isCheckmate(){return this.isCheck()&&this._moves().length===0}isStalemate(){return!this.isCheck()&&this._moves().length===0}isInsufficientMaterial(){const t={b:0,n:0,r:0,q:0,k:0,p:0},o=[];let r=0,i=0;for(let n=b.a8;n<=b.h1;n++){if(i=(i+1)%2,n&136){n+=7;continue}const a=this._board[n];a&&(t[a.type]=a.type in t?t[a.type]+1:1,a.type===me&&o.push(i),r++)}if(r===2||r===3&&(t[me]===1||t[Te]===1))return!0;if(r===t[me]+2){let n=0;const a=o.length;for(let s=0;s<a;s++)n+=o[s];if(n===0||n===a)return!0}return!1}isThreefoldRepetition(){const t=[],o={};let r=!1;for(;;){const i=this._undoMove();if(!i)break;t.push(i)}for(;;){const i=this.fen().split(" ").slice(0,4).join(" ");o[i]=i in o?o[i]+1:1,o[i]>=3&&(r=!0);const n=t.pop();if(n)this._makeMove(n);else break}return r}isDraw(){return this._halfMoves>=100||this.isStalemate()||this.isInsufficientMaterial()||this.isThreefoldRepetition()}isGameOver(){return this.isCheckmate()||this.isStalemate()||this.isDraw()}moves({verbose:t=!1,square:o=void 0,piece:r=void 0}={}){const i=this._moves({square:o,piece:r});return t?i.map(n=>this._makePretty(n)):i.map(n=>this._moveToSan(n,i))}_moves({legal:t=!0,piece:o=void 0,square:r=void 0}={}){var _;const i=r?r.toLowerCase():void 0,n=o==null?void 0:o.toLowerCase(),a=[],s=this._turn,l=ie(s);let c=b.a8,p=b.h1,u=!1;if(i)if(i in b)c=p=b[i],u=!0;else return[];for(let h=c;h<=p;h++){if(h&136){h+=7;continue}if(!this._board[h]||this._board[h].color===l)continue;const{type:f}=this._board[h];let v;if(f===C){if(n&&n!==f)continue;v=h+ye[s][0],this._board[v]||(W(a,s,h,v,C),v=h+ye[s][1],uo[s]===X(h)&&!this._board[v]&&W(a,s,h,v,C,void 0,m.BIG_PAWN));for(let S=2;S<4;S++)v=h+ye[s][S],!(v&136)&&(((_=this._board[v])==null?void 0:_.color)===l?W(a,s,h,v,C,this._board[v].type,m.CAPTURE):v===this._epSquare&&W(a,s,h,v,C,C,m.EP_CAPTURE))}else{if(n&&n!==f)continue;for(let S=0,g=je[f].length;S<g;S++){const k=je[f][S];for(v=h;v+=k,!(v&136);){if(!this._board[v])W(a,s,h,v,f);else{if(this._board[v].color===s)break;W(a,s,h,v,f,this._board[v].type,m.CAPTURE);break}if(f===Te||f===E)break}}}}if((n===void 0||n===E)&&(!u||p===this._kings[s])){if(this._castling[s]&m.KSIDE_CASTLE){const h=this._kings[s],f=h+2;!this._board[h+1]&&!this._board[f]&&!this._attacked(l,this._kings[s])&&!this._attacked(l,h+1)&&!this._attacked(l,f)&&W(a,s,this._kings[s],f,E,void 0,m.KSIDE_CASTLE)}if(this._castling[s]&m.QSIDE_CASTLE){const h=this._kings[s],f=h-2;!this._board[h-1]&&!this._board[h-2]&&!this._board[h-3]&&!this._attacked(l,this._kings[s])&&!this._attacked(l,h-1)&&!this._attacked(l,f)&&W(a,s,this._kings[s],f,E,void 0,m.QSIDE_CASTLE)}}if(!t||this._kings[s]===-1)return a;const d=[];for(let h=0,f=a.length;h<f;h++)this._makeMove(a[h]),this._isKingAttacked(s)||d.push(a[h]),this._undoMove();return d}move(t,{strict:o=!1}={}){let r=null;if(typeof t=="string")r=this._moveFromSan(t,o);else if(typeof t=="object"){const n=this._moves();for(let a=0,s=n.length;a<s;a++)if(t.from===q(n[a].from)&&t.to===q(n[a].to)&&(!("promotion"in n[a])||t.promotion===n[a].promotion)){r=n[a];break}}if(!r)throw typeof t=="string"?new Error(`Invalid move: ${t}`):new Error(`Invalid move: ${JSON.stringify(t)}`);const i=this._makePretty(r);return this._makeMove(r),i}_push(t){this._history.push({move:t,kings:{b:this._kings.b,w:this._kings.w},turn:this._turn,castling:{b:this._castling.b,w:this._castling.w},epSquare:this._epSquare,halfMoves:this._halfMoves,moveNumber:this._moveNumber})}_makeMove(t){const o=this._turn,r=ie(o);if(this._push(t),this._board[t.to]=this._board[t.from],delete this._board[t.from],t.flags&m.EP_CAPTURE&&(this._turn===x?delete this._board[t.to-16]:delete this._board[t.to+16]),t.promotion&&(this._board[t.to]={type:t.promotion,color:o}),this._board[t.to].type===E){if(this._kings[o]=t.to,t.flags&m.KSIDE_CASTLE){const i=t.to-1,n=t.to+1;this._board[i]=this._board[n],delete this._board[n]}else if(t.flags&m.QSIDE_CASTLE){const i=t.to+1,n=t.to-2;this._board[i]=this._board[n],delete this._board[n]}this._castling[o]=0}if(this._castling[o]){for(let i=0,n=Q[o].length;i<n;i++)if(t.from===Q[o][i].square&&this._castling[o]&Q[o][i].flag){this._castling[o]^=Q[o][i].flag;break}}if(this._castling[r]){for(let i=0,n=Q[r].length;i<n;i++)if(t.to===Q[r][i].square&&this._castling[r]&Q[r][i].flag){this._castling[r]^=Q[r][i].flag;break}}t.flags&m.BIG_PAWN?o===x?this._epSquare=t.to-16:this._epSquare=t.to+16:this._epSquare=N,t.piece===C?this._halfMoves=0:t.flags&(m.CAPTURE|m.EP_CAPTURE)?this._halfMoves=0:this._halfMoves++,o===x&&this._moveNumber++,this._turn=r}undo(){const t=this._undoMove();return t?this._makePretty(t):null}_undoMove(){const t=this._history.pop();if(t===void 0)return null;const o=t.move;this._kings=t.kings,this._turn=t.turn,this._castling=t.castling,this._epSquare=t.epSquare,this._halfMoves=t.halfMoves,this._moveNumber=t.moveNumber;const r=this._turn,i=ie(r);if(this._board[o.from]=this._board[o.to],this._board[o.from].type=o.piece,delete this._board[o.to],o.captured)if(o.flags&m.EP_CAPTURE){let n;r===x?n=o.to-16:n=o.to+16,this._board[n]={type:C,color:i}}else this._board[o.to]={type:o.captured,color:i};if(o.flags&(m.KSIDE_CASTLE|m.QSIDE_CASTLE)){let n,a;o.flags&m.KSIDE_CASTLE?(n=o.to+1,a=o.to-1):(n=o.to-2,a=o.to+1),this._board[n]=this._board[a],delete this._board[a]}return o}pgn({newline:t=`
`,maxWidth:o=0}={}){const r=[];let i=!1;for(const d in this._header)r.push("["+d+' "'+this._header[d]+'"]'+t),i=!0;i&&this._history.length&&r.push(t);const n=d=>{const _=this._comments[this.fen()];if(typeof _<"u"){const h=d.length>0?" ":"";d=`${d}${h}{${_}}`}return d},a=[];for(;this._history.length>0;)a.push(this._undoMove());const s=[];let l="";for(a.length===0&&s.push(n(""));a.length>0;){l=n(l);const d=a.pop();if(!d)break;if(!this._history.length&&d.color==="b"){const _=`${this._moveNumber}. ...`;l=l?`${l} ${_}`:_}else d.color==="w"&&(l.length&&s.push(l),l=this._moveNumber+".");l=l+" "+this._moveToSan(d,this._moves({legal:!0})),this._makeMove(d)}if(l.length&&s.push(n(l)),typeof this._header.Result<"u"&&s.push(this._header.Result),o===0)return r.join("")+s.join(" ");const c=function(){return r.length>0&&r[r.length-1]===" "?(r.pop(),!0):!1},p=function(d,_){for(const h of _.split(" "))if(h){if(d+h.length>o){for(;c();)d--;r.push(t),d=0}r.push(h),d+=h.length,r.push(" "),d++}return c()&&d--,d};let u=0;for(let d=0;d<s.length;d++){if(u+s[d].length>o&&s[d].includes("{")){u=p(u,s[d]);continue}u+s[d].length>o&&d!==0?(r[r.length-1]===" "&&r.pop(),r.push(t),u=0):d!==0&&(r.push(" "),u++),r.push(s[d]),u+=s[d].length}return r.join("")}header(...t){for(let o=0;o<t.length;o+=2)typeof t[o]=="string"&&typeof t[o+1]=="string"&&(this._header[t[o]]=t[o+1]);return this._header}loadPgn(t,{strict:o=!1,newlineChar:r=`\r?
`}={}){function i(g){return g.replace(/\\/g,"\\")}function n(g){const k={},L=g.split(new RegExp(i(r)));let T="",oe="";for(let F=0;F<L.length;F++){const w=/^\s*\[\s*([A-Za-z]+)\s*"(.*)"\s*\]\s*$/;T=L[F].replace(w,"$1"),oe=L[F].replace(w,"$2"),T.trim().length>0&&(k[T]=oe)}return k}t=t.trim();const a=new RegExp("^(\\[((?:"+i(r)+")|.)*\\])((?:\\s*"+i(r)+"){2}|(?:\\s*"+i(r)+")*$)").exec(t),s=a&&a.length>=2?a[1]:"";this.reset();const l=n(s);let c="";for(const g in l)g.toLowerCase()==="fen"&&(c=l[g]),this.header(g,l[g]);if(!o)c&&this.load(c,!0);else if(l.SetUp==="1"){if(!("FEN"in l))throw new Error("Invalid PGN: FEN tag must be supplied with SetUp tag");this.load(l.FEN,!0)}function p(g){return Array.from(g).map(function(k){return k.charCodeAt(0)<128?k.charCodeAt(0).toString(16):encodeURIComponent(k).replace(/%/g,"").toLowerCase()}).join("")}function u(g){return g.length==0?"":decodeURIComponent("%"+(g.match(/.{1,2}/g)||[]).join("%"))}const d=function(g){return g=g.replace(new RegExp(i(r),"g")," "),`{${p(g.slice(1,g.length-1))}}`},_=function(g){if(g.startsWith("{")&&g.endsWith("}"))return u(g.slice(1,g.length-1))};let h=t.replace(s,"").replace(new RegExp(`({[^}]*})+?|;([^${i(r)}]*)`,"g"),function(g,k,L){return k!==void 0?d(k):" "+d(`{${L.slice(1)}}`)}).replace(new RegExp(i(r),"g")," ");const f=/(\([^()]+\))+?/g;for(;f.test(h);)h=h.replace(f,"");h=h.replace(/\d+\.(\.\.)?/g,""),h=h.replace(/\.\.\./g,""),h=h.replace(/\$\d+/g,"");let v=h.trim().split(new RegExp(/\s+/));v=v.filter(g=>g!=="");let S="";for(let g=0;g<v.length;g++){const k=_(v[g]);if(k!==void 0){this._comments[this.fen()]=k;continue}const L=this._moveFromSan(v[g],o);if(L==null)if(po.indexOf(v[g])>-1)S=v[g];else throw new Error(`Invalid move in PGN: ${v[g]}`);else S="",this._makeMove(L)}S&&Object.keys(this._header).length&&!this._header.Result&&this.header("Result",S)}_moveToSan(t,o){let r="";if(t.flags&m.KSIDE_CASTLE)r="O-O";else if(t.flags&m.QSIDE_CASTLE)r="O-O-O";else{if(t.piece!==C){const i=go(t,o);r+=t.piece.toUpperCase()+i}t.flags&(m.CAPTURE|m.EP_CAPTURE)&&(t.piece===C&&(r+=q(t.from)[0]),r+="x"),r+=q(t.to),t.promotion&&(r+="="+t.promotion.toUpperCase())}return this._makeMove(t),this.isCheck()&&(this.isCheckmate()?r+="#":r+="+"),this._undoMove(),r}_moveFromSan(t,o=!1){const r=ke(t);let i=Ge(r),n=this._moves({legal:!0,piece:i});for(let d=0,_=n.length;d<_;d++)if(r===ke(this._moveToSan(n[d],n)))return n[d];if(o)return null;let a,s,l,c,p,u=!1;if(s=r.match(/([pnbrqkPNBRQK])?([a-h][1-8])x?-?([a-h][1-8])([qrbnQRBN])?/),s?(a=s[1],l=s[2],c=s[3],p=s[4],l.length==1&&(u=!0)):(s=r.match(/([pnbrqkPNBRQK])?([a-h]?[1-8]?)x?-?([a-h][1-8])([qrbnQRBN])?/),s&&(a=s[1],l=s[2],c=s[3],p=s[4],l.length==1&&(u=!0))),i=Ge(r),n=this._moves({legal:!0,piece:a||i}),!c)return null;for(let d=0,_=n.length;d<_;d++)if(l){if((!a||a.toLowerCase()==n[d].piece)&&b[l]==n[d].from&&b[c]==n[d].to&&(!p||p.toLowerCase()==n[d].promotion))return n[d];if(u){const h=q(n[d].from);if((!a||a.toLowerCase()==n[d].piece)&&b[c]==n[d].to&&(l==h[0]||l==h[1])&&(!p||p.toLowerCase()==n[d].promotion))return n[d]}}else if(r===ke(this._moveToSan(n[d],n)).replace("x",""))return n[d];return null}ascii(){let t=`   +------------------------+
`;for(let o=b.a8;o<=b.h1;o++){if(he(o)===0&&(t+=" "+"87654321"[X(o)]+" |"),this._board[o]){const r=this._board[o].type,i=this._board[o].color===M?r.toUpperCase():r.toLowerCase();t+=" "+i+" "}else t+=" . ";o+1&136&&(t+=`|
`,o+=8)}return t+=`   +------------------------+
`,t+="     a  b  c  d  e  f  g  h",t}perft(t){const o=this._moves({legal:!1});let r=0;const i=this._turn;for(let n=0,a=o.length;n<a;n++)this._makeMove(o[n]),this._isKingAttacked(i)||(t-1>0?r+=this.perft(t-1):r++),this._undoMove();return r}_makePretty(t){const{color:o,piece:r,from:i,to:n,flags:a,captured:s,promotion:l}=t;let c="";for(const _ in m)m[_]&a&&(c+=to[_]);const p=q(i),u=q(n),d={color:o,piece:r,from:p,to:u,san:this._moveToSan(t,this._moves({legal:!0})),flags:c,lan:p+u,before:this.fen(),after:""};return this._makeMove(t),d.after=this.fen(),this._undoMove(),s&&(d.captured=s),l&&(d.promotion=l,d.lan+=l),d}turn(){return this._turn}board(){const t=[];let o=[];for(let r=b.a8;r<=b.h1;r++)this._board[r]==null?o.push(null):o.push({square:q(r),type:this._board[r].type,color:this._board[r].color}),r+1&136&&(t.push(o),o=[],r+=8);return t}squareColor(t){if(t in b){const o=b[t];return(X(o)+he(o))%2===0?"light":"dark"}return null}history({verbose:t=!1}={}){const o=[],r=[];for(;this._history.length>0;)o.push(this._undoMove());for(;;){const i=o.pop();if(!i)break;t?r.push(this._makePretty(i)):r.push(this._moveToSan(i,this._moves())),this._makeMove(i)}return r}_pruneComments(){const t=[],o={},r=i=>{i in this._comments&&(o[i]=this._comments[i])};for(;this._history.length>0;)t.push(this._undoMove());for(r(this.fen());;){const i=t.pop();if(!i)break;this._makeMove(i),r(this.fen())}this._comments=o}getComment(){return this._comments[this.fen()]}setComment(t){this._comments[this.fen()]=t.replace("{","[").replace("}","]")}deleteComment(){const t=this._comments[this.fen()];return delete this._comments[this.fen()],t}getComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>({fen:t,comment:this._comments[t]}))}deleteComments(){return this._pruneComments(),Object.keys(this._comments).map(t=>{const o=this._comments[t];return delete this._comments[t],{fen:t,comment:o}})}setCastlingRights(t,o){for(const i of[E,G])o[i]!==void 0&&(o[i]?this._castling[t]|=ge[i]:this._castling[t]&=~ge[i]);this._updateCastlingRights();const r=this.getCastlingRights(t);return(o[E]===void 0||o[E]===r[E])&&(o[G]===void 0||o[G]===r[G])}getCastlingRights(t){return{[E]:(this._castling[t]&ge[E])!==0,[G]:(this._castling[t]&ge[G])!==0}}moveNumber(){return this._moveNumber}}function bo(e){const t=[];for(const o of e)t.push({orig:o.to,brush:"yellow"}),o.captured&&t.push({orig:o.from,dest:o.to,brush:"red"}),o.san.includes("+")&&t.push({orig:o.from,dest:o.to,brush:"blue"});return t}function Se(e){return e==="w"?"white":"black"}function He(e){const t=new Map;for(const o of oo){const r=e.moves({square:o,verbose:!0});r.length&&t.set(r[0].from,r.map(i=>i.to))}return t}function vo(e,t){if((t==null?void 0:t.type)!=="p")return!1;const o=(t==null?void 0:t.color)==="w"?"8":"1";return e[1]===o}function de(e){return!!e&&e instanceof Object&&!(e instanceof Array)&&!(e instanceof Function)}function be(e){return de(e)?Object.fromEntries(Object.entries(e).map(([t,o])=>[t,be(o)])):e}function ht(e,t){const o={...e,...t};for(const r in o)o[r]=de(e==null?void 0:e[r])&&de(t==null?void 0:t[r])?ht(e[r],t[r]):be(o[r]);return o}function dt(e,t){const o={};for(const r in t)if(de(e==null?void 0:e[r])&&de(t==null?void 0:t[r])){const i=dt(e[r],t[r]);Object.keys(i).length>0&&(o[r]=i)}else(e==null?void 0:e[r])!==t[r]&&(o[r]=t[r]);return o}const _o=new Map([["b1",["a3","c3"]],["g1",["f3","h3"]],["a2",["a3","a4"]],["b2",["b3","b4"]],["c2",["c3","c4"]],["d2",["d3","d4"]],["e2",["e3","e4"]],["f2",["f3","f4"]],["g2",["g3","g4"]],["h2",["h3","h4"]]]),wo="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1",yo={fen:wo,orientation:"white",turnColor:"white",coordinates:!1,autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:300},lastMove:void 0,movable:{free:!1,color:"white",showDests:!0,dests:_o,events:{after:()=>{},afterNewPiece:void 0},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{set:void 0,unset:void 0}},predroppable:{enabled:!1,events:{set:void 0,unset:void 0}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},selectable:{enabled:!0},events:{change:void 0,move:void 0,dropNewPiece:void 0,select:void 0,insert:void 0},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}}}},ko=["white","black"],Le=["a","b","c","d","e","f","g","h"],xe=["1","2","3","4","5","6","7","8"],So=[...xe].reverse(),Oe=Array.prototype.concat(...Le.map(e=>xe.map(t=>e+t))),O=e=>Oe[8*e[0]+e[1]],y=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],ut=Oe.map(y);function Co(e){let t;const o=()=>(t===void 0&&(t=e()),t);return o.clear=()=>{t=void 0},o}const Eo=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},De=e=>e==="white"?"black":"white",ue=(e,t)=>{const o=e[0]-t[0],r=e[1]-t[1];return o*o+r*r},Ae=(e,t)=>e.role===t.role&&e.color===t.color,pe=e=>(t,o)=>[(o?t[0]:7-t[0])*e.width/8,(o?7-t[1]:t[1])*e.height/8],V=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},pt=(e,t,o=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${o})`},Re=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ee=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},ft=e=>e.buttons===2||e.button===2,$=(e,t)=>{const o=document.createElement(e);return t&&(o.className=t),o};function gt(e,t,o){const r=y(e);return t||(r[0]=7-r[0],r[1]=7-r[1]),[o.left+o.width*r[0]/8+o.width/16,o.top+o.height*(7-r[1])/8+o.height/16]}const J=(e,t)=>Math.abs(e-t),Po=e=>(t,o,r,i)=>J(t,r)<2&&(e==="white"?i===o+1||o<=1&&i===o+2&&t===r:i===o-1||o>=6&&i===o-2&&t===r),mt=(e,t,o,r)=>{const i=J(e,o),n=J(t,r);return i===1&&n===2||i===2&&n===1},bt=(e,t,o,r)=>J(e,o)===J(t,r),vt=(e,t,o,r)=>e===o||t===r,_t=(e,t,o,r)=>bt(e,t,o,r)||vt(e,t,o,r),Mo=(e,t,o)=>(r,i,n,a)=>J(r,n)<2&&J(i,a)<2||o&&i===a&&i===(e==="white"?0:7)&&(r===4&&(n===2&&t.includes(0)||n===6&&t.includes(7))||t.includes(n));function To(e,t){const o=t==="white"?"1":"8",r=[];for(const[i,n]of e)i[1]===o&&n.color===t&&n.role==="rook"&&r.push(y(i)[0]);return r}function wt(e,t,o){const r=e.get(t);if(!r)return[];const i=y(t),n=r.role,a=n==="pawn"?Po(r.color):n==="knight"?mt:n==="bishop"?bt:n==="rook"?vt:n==="queen"?_t:Mo(r.color,To(e,r.color),o);return ut.filter(s=>(i[0]!==s[0]||i[1]!==s[1])&&a(i[0],i[1],s[0],s[1])).map(O)}function A(e,...t){e&&setTimeout(()=>e(...t),1)}function Ao(e){e.orientation=De(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function Io(e,t){for(const[o,r]of t)r?e.pieces.set(o,r):e.pieces.delete(o)}function No(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[o,r]of e.pieces)r.role==="king"&&r.color===t&&(e.check=o)}function qo(e,t,o,r){Z(e),e.premovable.current=[t,o],A(e.premovable.events.set,t,o,r)}function z(e){e.premovable.current&&(e.premovable.current=void 0,A(e.premovable.events.unset))}function Lo(e,t,o){z(e),e.predroppable.current={role:t,key:o},A(e.predroppable.events.set,t,o)}function Z(e){const t=e.predroppable;t.current&&(t.current=void 0,A(t.events.unset))}function xo(e,t,o){if(!e.autoCastle)return!1;const r=e.pieces.get(t);if(!r||r.role!=="king")return!1;const i=y(t),n=y(o);if(i[1]!==0&&i[1]!==7||i[1]!==n[1])return!1;i[0]===4&&!e.pieces.has(o)&&(n[0]===6?o=O([7,n[1]]):n[0]===2&&(o=O([0,n[1]])));const a=e.pieces.get(o);return!a||a.color!==r.color||a.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(o),i[0]<n[0]?(e.pieces.set(O([6,n[1]]),r),e.pieces.set(O([5,n[1]]),a)):(e.pieces.set(O([2,n[1]]),r),e.pieces.set(O([3,n[1]]),a)),!0)}function yt(e,t,o){const r=e.pieces.get(t),i=e.pieces.get(o);if(t===o||!r)return!1;const n=i&&i.color!==r.color?i:void 0;return o===e.selected&&D(e),A(e.events.move,t,o,n),xo(e,t,o)||(e.pieces.set(o,r),e.pieces.delete(t)),e.lastMove=[t,o],e.check=void 0,A(e.events.change),n||!0}function Ke(e,t,o,r){if(e.pieces.has(o))if(r)e.pieces.delete(o);else return!1;return A(e.events.dropNewPiece,t,o),e.pieces.set(o,t),e.lastMove=[o],e.check=void 0,A(e.events.change),e.movable.dests=void 0,e.turnColor=De(e.turnColor),!0}function kt(e,t,o){const r=yt(e,t,o);return r&&(e.movable.dests=void 0,e.turnColor=De(e.turnColor),e.animation.current=void 0),r}function St(e,t,o){if(Be(e,t,o)){const r=kt(e,t,o);if(r){const i=e.hold.stop();D(e);const n={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:i};return r!==!0&&(n.captured=r),A(e.movable.events.after,t,o,n),!0}}else if(Do(e,t,o))return qo(e,t,o,{ctrlKey:e.stats.ctrlKey}),D(e),!0;return D(e),!1}function Ct(e,t,o,r){const i=e.pieces.get(t);i&&(Oo(e,t,o)||r)?(e.pieces.delete(t),Ke(e,i,o,r),A(e.movable.events.afterNewPiece,i.role,o,{premove:!1,predrop:!1})):i&&Ro(e,t,o)?Lo(e,i.role,o):(z(e),Z(e)),e.pieces.delete(t),D(e)}function Ie(e,t,o){if(A(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){D(e),e.hold.cancel();return}else if((e.selectable.enabled||o)&&e.selected!==t&&St(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Pt(e,t)||Ve(e,t))&&(Et(e,t),e.hold.start())}function Et(e,t){e.selected=t,Ve(e,t)?e.premovable.dests=wt(e.pieces,t,e.premovable.castle):e.premovable.dests=void 0}function D(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Pt(e,t){const o=e.pieces.get(t);return!!o&&(e.movable.color==="both"||e.movable.color===o.color&&e.turnColor===o.color)}const Be=(e,t,o)=>{var r,i;return t!==o&&Pt(e,t)&&(e.movable.free||!!(!((i=(r=e.movable.dests)===null||r===void 0?void 0:r.get(t))===null||i===void 0)&&i.includes(o)))};function Oo(e,t,o){const r=e.pieces.get(t);return!!r&&(t===o||!e.pieces.has(o))&&(e.movable.color==="both"||e.movable.color===r.color&&e.turnColor===r.color)}function Ve(e,t){const o=e.pieces.get(t);return!!o&&e.premovable.enabled&&e.movable.color===o.color&&e.turnColor!==o.color}const Do=(e,t,o)=>t!==o&&Ve(e,t)&&wt(e.pieces,t,e.premovable.castle).includes(o);function Ro(e,t,o){const r=e.pieces.get(t),i=e.pieces.get(o);return!!r&&(!i||i.color!==e.movable.color)&&e.predroppable.enabled&&(r.role!=="pawn"||o[1]!=="1"&&o[1]!=="8")&&e.movable.color===r.color&&e.turnColor!==r.color}function Ko(e,t){const o=e.pieces.get(t);return!!o&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===o.color&&(e.turnColor===o.color||e.premovable.enabled))}function Bo(e){const t=e.premovable.current;if(!t)return!1;const o=t[0],r=t[1];let i=!1;if(Be(e,o,r)){const n=kt(e,o,r);if(n){const a={premove:!0};n!==!0&&(a.captured=n),A(e.movable.events.after,o,r,a),i=!0}}return z(e),i}function Vo(e,t){const o=e.predroppable.current;let r=!1;if(!o)return!1;if(t(o)){const i={role:o.role,color:e.movable.color};Ke(e,i,o.key)&&(A(e.movable.events.afterNewPiece,o.role,o.key,{premove:!1,predrop:!0}),r=!0)}return Z(e),r}function Fe(e){z(e),Z(e),D(e)}function ze(e){e.movable.color=e.movable.dests=e.animation.current=void 0,Fe(e)}function te(e,t,o){let r=Math.floor(8*(e[0]-o.left)/o.width);t||(r=7-r);let i=7-Math.floor(8*(e[1]-o.top)/o.height);return t||(i=7-i),r>=0&&r<8&&i>=0&&i<8?O([r,i]):void 0}function Fo(e,t,o,r){const i=y(e),n=ut.filter(l=>_t(i[0],i[1],l[0],l[1])||mt(i[0],i[1],l[0],l[1])),a=n.map(l=>gt(O(l),o,r)).map(l=>ue(t,l)),[,s]=a.reduce((l,c,p)=>l[0]<c?l:[c,p],[a[0],0]);return O(n[s])}const I=e=>e.orientation==="white",Mt="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",$o={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},Qo={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Tt(e){e==="start"&&(e=Mt);const t=new Map;let o=7,r=0;for(const i of e)switch(i){case" ":case"[":return t;case"/":if(--o,o<0)return t;r=0;break;case"~":{const n=t.get(O([r-1,o]));n&&(n.promoted=!0);break}default:{const n=i.charCodeAt(0);if(n<57)r+=n-48;else{const a=i.toLowerCase();t.set(O([r,o]),{role:$o[a],color:i===a?"black":"white"}),++r}}}return t}function Wo(e){return So.map(t=>Le.map(o=>{const r=e.get(o+t);if(r){let i=Qo[r.role];return r.color==="white"&&(i=i.toUpperCase()),r.promoted&&(i+="~"),i}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function At(e,t){t.animation&&($e(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function It(e,t){var o,r,i;if(!((o=t.movable)===null||o===void 0)&&o.dests&&(e.movable.dests=void 0),!((r=t.drawable)===null||r===void 0)&&r.autoShapes&&(e.drawable.autoShapes=[]),$e(e,t),t.fen&&(e.pieces=Tt(t.fen),e.drawable.shapes=((i=t.drawable)===null||i===void 0?void 0:i.shapes)||[]),"check"in t&&No(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Et(e,e.selected),At(e,t),!e.movable.rookCastle&&e.movable.dests){const n=e.movable.color==="white"?"1":"8",a="e"+n,s=e.movable.dests.get(a),l=e.pieces.get(a);if(!s||!l||l.role!=="king")return;e.movable.dests.set(a,s.filter(c=>!(c==="a"+n&&s.includes("c"+n))&&!(c==="h"+n&&s.includes("g"+n))))}}function $e(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&(Object.prototype.hasOwnProperty.call(e,o)&&Ze(e[o])&&Ze(t[o])?$e(e[o],t[o]):e[o]=t[o])}function Ze(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const Y=(e,t)=>t.animation.enabled?Go(e,t):U(e,t);function U(e,t){const o=e(t);return t.dom.redraw(),o}const Ce=(e,t)=>({key:e,pos:y(e),piece:t}),jo=(e,t)=>t.sort((o,r)=>ue(e.pos,o.pos)-ue(e.pos,r.pos))[0];function Uo(e,t){const o=new Map,r=[],i=new Map,n=[],a=[],s=new Map;let l,c,p;for(const[u,d]of e)s.set(u,Ce(u,d));for(const u of Oe)l=t.pieces.get(u),c=s.get(u),l?c?Ae(l,c.piece)||(n.push(c),a.push(Ce(u,l))):a.push(Ce(u,l)):c&&n.push(c);for(const u of a)c=jo(u,n.filter(d=>Ae(u.piece,d.piece))),c&&(p=[c.pos[0]-u.pos[0],c.pos[1]-u.pos[1]],o.set(u.key,p.concat(p)),r.push(c.key));for(const u of n)r.includes(u.key)||i.set(u.key,u.piece);return{anims:o,fadings:i}}function Nt(e,t){const o=e.animation.current;if(o===void 0){e.dom.destroyed||e.dom.redrawNow();return}const r=1-(t-o.start)*o.frequency;if(r<=0)e.animation.current=void 0,e.dom.redrawNow();else{const i=Ho(r);for(const n of o.plan.anims.values())n[2]=n[0]*i,n[3]=n[1]*i;e.dom.redrawNow(!0),requestAnimationFrame((n=performance.now())=>Nt(e,n))}}function Go(e,t){const o=new Map(t.pieces),r=e(t),i=Uo(o,t);if(i.anims.size||i.fadings.size){const n=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:i},n||Nt(t,performance.now())}else t.dom.redraw();return r}const Ho=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,zo=["green","red","blue","yellow"];function Zo(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?D(e):Fe(e);const o=ee(t),r=te(o,I(e),e.dom.bounds());r&&(e.drawable.current={orig:r,pos:o,brush:er(t),snapToValidMove:e.drawable.defaultSnapToValidMove},qt(e))}function qt(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const o=te(t.pos,I(e),e.dom.bounds());o||(t.snapToValidMove=!1);const r=t.snapToValidMove?Fo(t.orig,t.pos,I(e),e.dom.bounds()):o;r!==t.mouseSq&&(t.mouseSq=r,t.dest=r!==t.orig?r:void 0,e.dom.redrawNow()),qt(e)}})}function Yo(e,t){e.drawable.current&&(e.drawable.current.pos=ee(t))}function Xo(e){const t=e.drawable.current;t&&(t.mouseSq&&tr(e.drawable,t),Lt(e))}function Lt(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Jo(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),xt(e.drawable))}function er(e){var t;const o=(e.shiftKey||e.ctrlKey)&&ft(e),r=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return zo[(o?1:0)+(r?2:0)]}function tr(e,t){const o=i=>i.orig===t.orig&&i.dest===t.dest,r=e.shapes.find(o);r&&(e.shapes=e.shapes.filter(i=>!o(i))),(!r||r.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),xt(e)}function xt(e){e.onChange&&e.onChange(e.shapes)}function or(e,t){if(!t.isTrusted||t.button!==void 0&&t.button!==0||t.touches&&t.touches.length>1)return;const o=e.dom.bounds(),r=ee(t),i=te(r,I(e),o);if(!i)return;const n=e.pieces.get(i),a=e.selected;!a&&e.drawable.enabled&&(e.drawable.eraseOnClick||!n||n.color!==e.turnColor)&&Jo(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||n||a||rr(e,r))&&t.preventDefault();const s=!!e.premovable.current,l=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&Be(e,e.selected,i)?Y(u=>Ie(u,i),e):Ie(e,i);const c=e.selected===i,p=Dt(e,i);if(n&&p&&c&&Ko(e,i)){e.draggable.current={orig:i,piece:n,origPos:r,pos:r,started:e.draggable.autoDistance&&e.stats.dragged,element:p,previouslySelected:a,originTarget:t.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const u=e.dom.elements.ghost;u&&(u.className=`ghost ${n.color} ${n.role}`,V(u,pe(o)(y(i),I(e))),Re(u,!0)),Qe(e)}else s&&z(e),l&&Z(e);e.dom.redraw()}function rr(e,t){const o=I(e),r=e.dom.bounds(),i=Math.pow(r.width/8,2);for(const n of e.pieces.keys()){const a=gt(n,o,r);if(ue(a,t)<=i)return!0}return!1}function ir(e,t,o,r){const i="a0";e.pieces.set(i,t),e.dom.redraw();const n=ee(o);e.draggable.current={orig:i,piece:t,origPos:n,pos:n,started:!0,element:()=>Dt(e,i),originTarget:o.target,newPiece:!0,force:!!r,keyHasChanged:!1},Qe(e)}function Qe(e){requestAnimationFrame(()=>{var t;const o=e.draggable.current;if(!o)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(o.orig)&&(e.animation.current=void 0);const r=e.pieces.get(o.orig);if(!r||!Ae(r,o.piece))ve(e);else if(!o.started&&ue(o.pos,o.origPos)>=Math.pow(e.draggable.distance,2)&&(o.started=!0),o.started){if(typeof o.element=="function"){const n=o.element();if(!n)return;n.cgDragging=!0,n.classList.add("dragging"),o.element=n}const i=e.dom.bounds();V(o.element,[o.pos[0]-i.left-i.width/16,o.pos[1]-i.top-i.height/16]),o.keyHasChanged||(o.keyHasChanged=o.orig!==te(o.pos,I(e),i))}Qe(e)})}function nr(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ee(t))}function sr(e,t){const o=e.draggable.current;if(!o)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&o.originTarget!==t.target&&!o.newPiece){e.draggable.current=void 0;return}z(e),Z(e);const r=ee(t)||o.pos,i=te(r,I(e),e.dom.bounds());i&&o.started&&o.orig!==i?o.newPiece?Ct(e,o.orig,i,o.force):(e.stats.ctrlKey=t.ctrlKey,St(e,o.orig,i)&&(e.stats.dragged=!0)):o.newPiece?e.pieces.delete(o.orig):e.draggable.deleteOnDropOff&&!i&&(e.pieces.delete(o.orig),A(e.events.change)),(o.orig===o.previouslySelected||o.keyHasChanged)&&(o.orig===i||!i)?D(e):e.selectable.enabled||D(e),Ot(e),e.draggable.current=void 0,e.dom.redraw()}function ve(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,D(e),Ot(e),e.dom.redraw())}function Ot(e){const t=e.dom.elements;t.ghost&&Re(t.ghost,!1)}function Dt(e,t){let o=e.dom.elements.board.firstChild;for(;o;){if(o.cgKey===t&&o.tagName==="PIECE")return o;o=o.nextSibling}}function ar(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{Ye(e,2),setTimeout(()=>Ye(e,void 0),120)},120)}function Ye(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function lr(e,t){function o(){Ao(e),t()}return{set(r){r.orientation&&r.orientation!==e.orientation&&o(),At(e,r),(r.fen?Y:U)(i=>It(i,r),e)},state:e,getFen:()=>Wo(e.pieces),toggleOrientation:o,setPieces(r){Y(i=>Io(i,r),e)},selectSquare(r,i){r?Y(n=>Ie(n,r,i),e):e.selected&&(D(e),e.dom.redraw())},move(r,i){Y(n=>yt(n,r,i),e)},newPiece(r,i){Y(n=>Ke(n,r,i),e)},playPremove(){if(e.premovable.current){if(Y(Bo,e))return!0;e.dom.redraw()}return!1},playPredrop(r){if(e.predroppable.current){const i=Vo(e,r);return e.dom.redraw(),i}return!1},cancelPremove(){U(z,e)},cancelPredrop(){U(Z,e)},cancelMove(){U(r=>{Fe(r),ve(r)},e)},stop(){U(r=>{ze(r),ve(r)},e)},explode(r){ar(e,r)},setAutoShapes(r){U(i=>i.drawable.autoShapes=r,e)},setShapes(r){U(i=>i.drawable.shapes=r,e)},getKeyAtDomPos(r){return te(r,I(e),e.dom.bounds())},redrawAll:t,dragNewPiece(r,i,n){ir(e,r,i,n)},destroy(){ze(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function cr(){return{pieces:Tt(Mt),orientation:"white",turnColor:"white",coordinates:!0,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15}},prevSvgHash:""},hold:Eo()}}function Ne(e,t,o){const r=new Map,i=[];for(const s of e)r.set(s.hash,!1);let n=t.firstChild,a;for(;n;)a=n.getAttribute("cgHash"),r.has(a)?r.set(a,!0):i.push(n),n=n.nextSibling;for(const s of i)t.removeChild(s);for(const s of e)r.get(s.hash)||t.appendChild(o(s))}function R(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function hr(e,t,o){const r=e.drawable,i=r.current,n=i&&i.mouseSq?i:void 0,a=new Map,s=e.dom.bounds(),l=r.autoShapes.filter(h=>!h.piece);for(const h of r.shapes.concat(l).concat(n?[n]:[]))h.dest&&a.set(h.dest,(a.get(h.dest)||0)+1);const c=r.shapes.concat(l).map(h=>({shape:h,current:!1,hash:Xe(h,a,!1,s)}));n&&c.push({shape:n,current:!0,hash:Xe(n,a,!0,s)});const p=c.map(h=>h.hash).join(";");if(p===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=p;const u=t.querySelector("defs"),d=t.querySelector("g"),_=o.querySelector("g");dr(r,c,u),Ne(c.filter(h=>!h.shape.customSvg),d,h=>Je(e,h,r.brushes,a,s)),Ne(c.filter(h=>h.shape.customSvg),_,h=>Je(e,h,r.brushes,a,s))}function dr(e,t,o){const r=new Map;let i;for(const s of t)s.shape.dest&&(i=e.brushes[s.shape.brush],s.shape.modifiers&&(i=Rt(i,s.shape.modifiers)),r.set(i.key,i));const n=new Set;let a=o.firstChild;for(;a;)n.add(a.getAttribute("cgKey")),a=a.nextSibling;for(const[s,l]of r.entries())n.has(s)||o.appendChild(vr(l))}function Xe({orig:e,dest:t,brush:o,piece:r,modifiers:i,customSvg:n},a,s,l){return[l.width,l.height,s,e,t,o,t&&(a.get(t)||0)>1,r&&ur(r),i&&pr(i),n&&fr(n)].filter(c=>c).join(",")}function ur(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function pr(e){return""+(e.lineWidth||"")}function fr(e){let t=0;for(let o=0;o<e.length;o++)t=(t<<5)-t+e.charCodeAt(o)>>>0;return"custom-"+t.toString()}function Je(e,{shape:t,current:o,hash:r},i,n,a){let s;const l=et(y(t.orig),e.orientation);if(t.customSvg)s=gr(t.customSvg,l,a);else if(t.dest){let c=i[t.brush];t.modifiers&&(c=Rt(c,t.modifiers)),s=br(c,l,et(y(t.dest),e.orientation),o,(n.get(t.dest)||0)>1,a)}else s=mr(i[t.brush],l,o,a);return s.setAttribute("cgHash",r),s}function gr(e,t,o){const[r,i]=_e(t,o),n=H(R("g"),{transform:`translate(${r},${i})`}),a=H(R("svg"),{width:1,height:1,viewBox:"0 0 100 100"});return n.appendChild(a),a.innerHTML=e,n}function mr(e,t,o,r){const i=_e(t,r),n=_r(),a=(r.width+r.height)/(4*Math.max(r.width,r.height));return H(R("circle"),{stroke:e.color,"stroke-width":n[o?0:1],fill:"none",opacity:Kt(e,o),cx:i[0],cy:i[1],r:a-n[1]/2})}function br(e,t,o,r,i,n){const a=yr(i&&!r),s=_e(t,n),l=_e(o,n),c=l[0]-s[0],p=l[1]-s[1],u=Math.atan2(p,c),d=Math.cos(u)*a,_=Math.sin(u)*a;return H(R("line"),{stroke:e.color,"stroke-width":wr(e,r),"stroke-linecap":"round","marker-end":"url(#arrowhead-"+e.key+")",opacity:Kt(e,r),x1:s[0],y1:s[1],x2:l[0]-d,y2:l[1]-_})}function vr(e){const t=H(R("marker"),{id:"arrowhead-"+e.key,orient:"auto",markerWidth:4,markerHeight:8,refX:2.05,refY:2.01});return t.appendChild(H(R("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function H(e,t){for(const o in t)Object.prototype.hasOwnProperty.call(t,o)&&e.setAttribute(o,t[o]);return e}function et(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Rt(e,t){return{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(o=>o).join("")}}function _r(){return[3/64,4/64]}function wr(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function Kt(e,t){return(e.opacity||1)*(t?.9:1)}function yr(e){return(e?20:10)/64}function _e(e,t){const o=Math.min(1,t.width/t.height),r=Math.min(1,t.height/t.width);return[(e[0]-3.5)*o,(3.5-e[1])*r]}function kr(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const l of ko)e.classList.toggle("orientation-"+l,t.orientation===l);e.classList.toggle("manipulable",!t.viewOnly);const o=$("cg-container");e.appendChild(o);const r=$("cg-board");o.appendChild(r);let i,n,a;if(t.drawable.visible&&(i=H(R("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),i.appendChild(R("defs")),i.appendChild(R("g")),n=H(R("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),n.appendChild(R("g")),a=$("cg-auto-pieces"),o.appendChild(i),o.appendChild(n),o.appendChild(a)),t.coordinates){const l=t.orientation==="black"?" black":"",c=t.ranksPosition==="left"?" left":"";o.appendChild(tt(xe,"ranks"+l+c)),o.appendChild(tt(Le,"files"+l))}let s;return t.draggable.enabled&&t.draggable.showGhost&&(s=$("piece","ghost"),Re(s,!1),o.appendChild(s)),{board:r,container:o,wrap:e,ghost:s,svg:i,customSvg:n,autoPieces:a}}function tt(e,t){const o=$("coords",t);let r;for(const i of e)r=$("coord"),r.textContent=i,o.appendChild(r);return o}function Sr(e,t){if(!e.dropmode.active)return;z(e),Z(e);const o=e.dropmode.piece;if(o){e.pieces.set("a0",o);const r=ee(t),i=r&&te(r,I(e),e.dom.bounds());i&&Ct(e,"a0",i)}e.dom.redraw()}function Cr(e,t){const o=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&o.addEventListener("contextmenu",i=>i.preventDefault()),e.viewOnly)return;const r=Pr(e);o.addEventListener("touchstart",r,{passive:!1}),o.addEventListener("mousedown",r,{passive:!1})}function Er(e,t){const o=[];if("ResizeObserver"in window||o.push(ne(document.body,"chessground.resize",t)),!e.viewOnly){const r=ot(e,nr,Yo),i=ot(e,sr,Xo);for(const a of["touchmove","mousemove"])o.push(ne(document,a,r));for(const a of["touchend","mouseup"])o.push(ne(document,a,i));const n=()=>e.dom.bounds.clear();o.push(ne(document,"scroll",n,{capture:!0,passive:!0})),o.push(ne(window,"resize",n,{passive:!0}))}return()=>o.forEach(r=>r())}function ne(e,t,o,r){return e.addEventListener(t,o,r),()=>e.removeEventListener(t,o,r)}const Pr=e=>t=>{e.draggable.current?ve(e):e.drawable.current?Lt(e):t.shiftKey||ft(t)?e.drawable.enabled&&Zo(e,t):e.viewOnly||(e.dropmode.active?Sr(e,t):or(e,t))},ot=(e,t,o)=>r=>{e.drawable.current?e.drawable.enabled&&o(e,r):e.viewOnly||t(e,r)};function Mr(e){const t=I(e),o=pe(e.dom.bounds()),r=e.dom.elements.board,i=e.pieces,n=e.animation.current,a=n?n.plan.anims:new Map,s=n?n.plan.fadings:new Map,l=e.draggable.current,c=Ar(e),p=new Set,u=new Set,d=new Map,_=new Map;let h,f,v,S,g,k,L,T,oe,F;for(f=r.firstChild;f;){if(h=f.cgKey,Bt(f))if(v=i.get(h),g=a.get(h),k=s.get(h),S=f.cgPiece,f.cgDragging&&(!l||l.orig!==h)&&(f.classList.remove("dragging"),V(f,o(y(h),t)),f.cgDragging=!1),!k&&f.cgFading&&(f.cgFading=!1,f.classList.remove("fading")),v){if(g&&f.cgAnimating&&S===se(v)){const w=y(h);w[0]+=g[2],w[1]+=g[3],f.classList.add("anim"),V(f,o(w,t))}else f.cgAnimating&&(f.cgAnimating=!1,f.classList.remove("anim"),V(f,o(y(h),t)),e.addPieceZIndex&&(f.style.zIndex=Ee(y(h),t)));S===se(v)&&(!k||!f.cgFading)?p.add(h):k&&S===se(k)?(f.classList.add("fading"),f.cgFading=!0):Pe(d,S,f)}else Pe(d,S,f);else if(Vt(f)){const w=f.className;c.get(h)===w?u.add(h):Pe(_,w,f)}f=f.nextSibling}for(const[w,re]of c)if(!u.has(w)){oe=_.get(re),F=oe&&oe.pop();const K=o(y(w),t);if(F)F.cgKey=w,V(F,K);else{const B=$("square",re);B.cgKey=w,V(B,K),r.insertBefore(B,r.firstChild)}}for(const[w,re]of i)if(g=a.get(w),!p.has(w))if(L=d.get(se(re)),T=L&&L.pop(),T){T.cgKey=w,T.cgFading&&(T.classList.remove("fading"),T.cgFading=!1);const K=y(w);e.addPieceZIndex&&(T.style.zIndex=Ee(K,t)),g&&(T.cgAnimating=!0,T.classList.add("anim"),K[0]+=g[2],K[1]+=g[3]),V(T,o(K,t))}else{const K=se(re),B=$("piece",K),fe=y(w);B.cgPiece=K,B.cgKey=w,g&&(B.cgAnimating=!0,fe[0]+=g[2],fe[1]+=g[3]),V(B,o(fe,t)),e.addPieceZIndex&&(B.style.zIndex=Ee(fe,t)),r.appendChild(B)}for(const w of d.values())it(e,w);for(const w of _.values())it(e,w)}function Tr(e){const t=I(e),o=pe(e.dom.bounds());let r=e.dom.elements.board.firstChild;for(;r;)(Bt(r)&&!r.cgAnimating||Vt(r))&&V(r,o(y(r.cgKey),t)),r=r.nextSibling}function rt(e){var t,o;const r=e.dom.elements.wrap.getBoundingClientRect(),i=e.dom.elements.container,n=r.height/r.width,a=Math.floor(r.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,s=a*n;i.style.width=a+"px",i.style.height=s+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("--cg-width",a+"px"),(o=e.addDimensionsCssVarsTo)===null||o===void 0||o.style.setProperty("--cg-height",s+"px")}const Bt=e=>e.tagName==="PIECE",Vt=e=>e.tagName==="SQUARE";function it(e,t){for(const o of t)e.dom.elements.board.removeChild(o)}function Ee(e,t){const o=e[1];return`${t?3+7-o:3+o}`}const se=e=>`${e.color} ${e.role}`;function Ar(e){var t;const o=new Map;if(e.lastMove&&e.highlight.lastMove)for(const n of e.lastMove)j(o,n,"last-move");if(e.check&&e.highlight.check&&j(o,e.check,"check"),e.selected&&(j(o,e.selected,"selected"),e.movable.showDests)){const n=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(n)for(const s of n)j(o,s,"move-dest"+(e.pieces.has(s)?" oc":""));const a=e.premovable.dests;if(a)for(const s of a)j(o,s,"premove-dest"+(e.pieces.has(s)?" oc":""))}const r=e.premovable.current;if(r)for(const n of r)j(o,n,"current-premove");else e.predroppable.current&&j(o,e.predroppable.current.key,"current-premove");const i=e.exploding;if(i)for(const n of i.keys)j(o,n,"exploding"+i.stage);return o}function j(e,t,o){const r=e.get(t);r?e.set(t,`${r} ${o}`):e.set(t,o)}function Pe(e,t,o){const r=e.get(t);r?r.push(o):e.set(t,[o])}function Ir(e,t){const o=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:Lr(r),current:!1}));Ne(o,t,r=>qr(e,r,e.dom.bounds()))}function Nr(e){var t;const o=I(e),r=pe(e.dom.bounds());let i=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;i;)pt(i,r(y(i.cgKey),o),i.cgScale),i=i.nextSibling}function qr(e,{shape:t,hash:o},r){var i,n,a;const s=t.orig,l=(i=t.piece)===null||i===void 0?void 0:i.role,c=(n=t.piece)===null||n===void 0?void 0:n.color,p=(a=t.piece)===null||a===void 0?void 0:a.scale,u=$("piece",`${l} ${c}`);return u.setAttribute("cgHash",o),u.cgKey=s,u.cgScale=p,pt(u,pe(r)(y(s),I(e)),p),u}const Lr=e=>{var t,o,r;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(o=e.piece)===null||o===void 0?void 0:o.color,(r=e.piece)===null||r===void 0?void 0:r.scale].join(",")};function xr(e,t){const o=cr();It(o,t||{});function r(){const i="dom"in o?o.dom.unbind:void 0,n=kr(e,o),a=Co(()=>n.board.getBoundingClientRect()),s=p=>{Mr(c),n.autoPieces&&Ir(c,n.autoPieces),!p&&n.svg&&hr(c,n.svg,n.customSvg)},l=()=>{rt(c),Tr(c),n.autoPieces&&Nr(c)},c=o;return c.dom={elements:n,bounds:a,redraw:Or(s),redrawNow:s,unbind:i},c.drawable.prevSvgHash="",rt(c),s(!1),Cr(c,l),i||(c.dom.unbind=Er(c,l)),c.events.insert&&c.events.insert(n),c}return lr(r(),r)}function Or(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}class Dr{constructor(t,o,r,i){P(this,"game");P(this,"board");P(this,"boardState");P(this,"props");P(this,"emit");this.boardState=o,this.props=r,this.emit=i,this.game=new mo,this.board=xr(t),this.resetBoard()}updateGameState({updateFen:t=!0}={}){this.boardState.historyViewerState.isEnabled||(t&&this.board.set({fen:this.game.fen()}),this.board.state.turnColor=this.getTurnColor(),this.board.state.movable.color=this.props.playerColor||this.board.state.turnColor,this.board.state.movable.dests=He(this.game),this.displayInCheck(this.game.inCheck(),this.board.state.turnColor),this.boardState.showThreats&&this.drawMoves()),this.emitEvents()}displayInCheck(t,o){if(t){for(const[r,i]of this.board.state.pieces)if(i.role==="king"&&i.color===o){this.board.state.check=r;return}}else this.board.state.check=void 0}emitEvents(){this.game.inCheck()&&this.emit(this.game.isCheckmate()?"checkmate":"check",this.board.state.turnColor),this.game.isDraw()&&this.emit("draw"),this.game.isStalemate()&&this.emit("stalemate")}async changeTurn(t,o,r){let i;vo(o,this.game.get(t))&&(i=await new Promise(n=>{this.boardState.promotionDialogState={isEnabled:!0,color:this.getTurnColor(),callback:n}})),this.move({from:t,to:o,promotion:i})}resetBoard(){this.setConfig(this.props.boardConfig,!0)}undoLastMove(){const t=this.game.undo();if(t!=null&&(this.boardState.historyViewerState.isEnabled&&this.boardState.historyViewerState.plyViewing===this.getCurrentPlyNumber()&&this.stopViewingHistory(),!this.boardState.historyViewerState.isEnabled)){this.board.set({fen:t.before}),this.updateGameState({updateFen:!1});const o=this.getLastMove();this.board.state.lastMove=o?[o==null?void 0:o.from,o==null?void 0:o.to]:void 0}}getMaterialCount(){const t=this.board.state.pieces,o={pawn:1,knight:3,bishop:3,rook:5,queen:9,king:0},r={materialWhite:0,materialBlack:0,materialDiff:0};for(const i of t)i[1].color==="white"?r.materialWhite+=o[i[1].role]:r.materialBlack+=o[i[1].role];return r.materialDiff=r.materialWhite-r.materialBlack,r}toggleOrientation(){this.board.toggleOrientation()}drawMoves(){this.boardState.showThreats=!0,this.board.setShapes(bo(this.game.moves({verbose:!0})))}hideMoves(){this.boardState.showThreats=!1,this.board.setShapes([])}drawMove(t,o,r){this.board.setShapes([{orig:t,dest:o,brush:r}])}toggleMoves(){this.boardState.showThreats?this.hideMoves():this.drawMoves()}async getOpeningName(){var t;try{const o=this.game.history({verbose:!0}).map(r=>r.lan).join(",");return((t=(await(await fetch(`https://explorer.lichess.ovh/masters?play=${o}`)).json()).opening)==null?void 0:t.name)??null}catch{return null}}move(t){let o;try{o=this.game.move(t)}catch{return!1}return this.emit("move",o),o!=null&&o.promotion&&this.emit("promotion",{color:Se(o.color),promotedTo:o.promotion.toUpperCase(),sanMove:o.san}),this.boardState.historyViewerState.isEnabled||(this.board.move(o.from,o.to),(o.flags==="e"||o!=null&&o.promotion)&&setTimeout(()=>this.board.set({fen:o.after}),this.board.state.animation.current?this.board.state.animation.duration:0),this.updateGameState({updateFen:!1}),Ht(this.board.playPremove)),!0}getTurnColor(){return Se(this.game.turn())}getPossibleMoves(){return He(this.game)}getCurrentTurnNumber(){return this.game.moveNumber()}getCurrentPlyNumber(){return 2*this.getCurrentTurnNumber()-(this.getTurnColor()==="black"?1:2)}getLastMove(){return this.game.history({verbose:!0}).at(-1)}getHistory(t=!1){return this.game.history({verbose:t})}getFen(){return this.game.fen()}getBoardPosition(){return this.game.board()}getPgn(){return this.game.pgn()}getIsGameOver(){return this.game.isGameOver()}getIsCheckmate(){return this.game.isCheckmate()}getIsCheck(){return this.game.isCheck()}getIsStalemate(){return this.game.isStalemate()}getIsDraw(){return this.game.isDraw()}getIsThreefoldRepetition(){return this.game.isThreefoldRepetition()}getIsInsufficientMaterial(){return this.game.isInsufficientMaterial()}getSquareColor(t){return this.game.squareColor(t)}getSquare(t){return this.game.get(t)}setPosition(t){this.game.load(t),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState()}putPiece(t,o){const r=this.game.put(t,o);return r&&this.updateGameState(),r}clearBoard(){this.game.clear(),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState()}setShapes(t){this.board.setShapes(t)}loadPgn(t){this.game.loadPgn(t),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState();const o=this.getLastMove();o&&this.board.set({lastMove:[o.from,o.to]})}getPgnInfo(){return this.game.header()}setConfig(t,o=!1){var n;if(o&&(t=ht(yo,t)),((n=t.movable)==null?void 0:n.events)&&"after"in t.movable.events){const a=t.movable.events.after;t.movable.events.after=a?async(...s)=>{await this.changeTurn(...s),a(...s)}:this.changeTurn.bind(this)}const{fen:r,...i}=t;this.board.set(i),r&&this.setPosition(r),this.board.redrawAll()}viewHistory(t){const o=this.getHistory(!0);if(t<0||t>o.length)return;const r=this.board.state.animation.enabled&&(this.boardState.historyViewerState.isEnabled&&Math.abs(this.boardState.historyViewerState.plyViewing-t)!==1||!this.boardState.historyViewerState.isEnabled&&t!==o.length-1);if(r&&this.board.set({animation:{enabled:!1}}),t<o.length)this.boardState.historyViewerState.isEnabled?this.boardState.historyViewerState.plyViewing=t:this.boardState.historyViewerState={isEnabled:!0,plyViewing:t,viewOnly:this.board.state.viewOnly},this.board.set({fen:o[t].before,viewOnly:!0,lastMove:t>0?[o[t-1].from,o[t-1].to]:void 0,selected:void 0}),this.displayInCheck(t>0?"+#".includes(o[t-1].san.at(-1)):!1,Se(o[t].color)),this.board.cancelPremove();else if(this.boardState.historyViewerState.isEnabled){const i=o.at(-1);this.board.set({fen:i.after,viewOnly:this.boardState.historyViewerState.viewOnly,lastMove:[i.from,i.to]}),this.boardState.historyViewerState={isEnabled:!1},this.updateGameState({updateFen:!1})}r&&this.board.set({animation:{enabled:!0}})}stopViewingHistory(){this.boardState.historyViewerState.isEnabled&&this.viewHistory(this.getCurrentPlyNumber())}viewStart(){this.viewHistory(0)}viewNext(){this.boardState.historyViewerState.isEnabled&&this.viewHistory(this.boardState.historyViewerState.plyViewing+1)}viewPrevious(){const t=this.boardState.historyViewerState.isEnabled?this.boardState.historyViewerState.plyViewing:this.getCurrentPlyNumber();this.viewHistory(t-1)}}const Rr={class:"main-board"},Kr={class:"dialog-container"},Br=nt({__name:"TheChessboard",props:{boardConfig:{default:()=>({})},playerColor:{},reactiveConfig:{type:Boolean,default:!1}},emits:["boardCreated","check","checkmate","stalemate","draw","promotion","move"],setup(e,{emit:t}){const o=e,r=Qt(null),i=We({showThreats:!1,promotionDialogState:{isEnabled:!1},historyViewerState:{isEnabled:!1}});return st(()=>{if(r.value==null)throw new Error("vue3-chessboard: Failed to mount board.");const n=new Dr(r.value,i,o,t);if(t("boardCreated",n),o.reactiveConfig){let a=be(o.boardConfig);Me(We(o.boardConfig),s=>{n.setConfig(dt(a,s)),a=be(s)})}}),(n,a)=>(ce(),qe("section",{class:lt(["main-wrap",{disabledBoard:i.promotionDialogState.isEnabled,viewingHistory:i.historyViewerState.isEnabled}])},[le("div",Rr,[le("div",Kr,[i.promotionDialogState.isEnabled?(ce(),at(eo,{key:0,state:i.promotionDialogState,onPromotionSelected:a[0]||(a[0]=s=>i.promotionDialogState={isEnabled:!1})},null,8,["state"])):Wt("",!0)]),le("div",{ref_key:"boardElement",ref:r},null,512)])],2))}});const Vr={class:"w-full grid items-center h-full"},Qr={__name:"Chessboard",props:["fen","orientation"],emits:["move"],setup(e,{emit:t}){const o=e,r={orientation:o.orientation};let i;return Me(()=>o.fen,()=>{i.setPosition(o.fen)}),Me(()=>o.orientation,()=>{i.toggleOrientation()}),st(()=>{t("board-created",i)}),(n,a)=>(ce(),qe("div",Vr,[zt(Yt(Br),{onMove:a[0]||(a[0]=s=>{t("move",s)}),onBoardCreated:a[1]||(a[1]=s=>Zt(i)?i.value=s:i=s),"board-config":r})]))}};export{Qr as _};
